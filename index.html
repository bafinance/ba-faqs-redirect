<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Follow-up Ticket Status â€” BA IT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#0a6bff;
      --muted:#6c7680;
      --bg:#f5f7fb;
      --card:#ffffff;
      --accent:#0a3ea8;
      --danger:#b93b3b;
      --ok:#2b7a2b;
    }
    html,body{height:100%}
    body{
      margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,#f7f8fb 0%, #f3f6fa 100%);color:#111;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:980px;margin:28px auto;padding:18px}
    header{display:block;text-align:center;margin-bottom:18px}
    header img{width:100%;max-height:140px;object-fit:cover;border-radius:8px;box-shadow:0 6px 20px rgba(10,10,20,.06)}
    .card{background:var(--card);border-radius:14px;padding:22px;box-shadow:0 12px 40px rgba(10,20,40,.06)}
    h1{margin:0 0 8px 0;font-size:22px}
    p.hint{margin:6px 0 16px;color:var(--muted);font-size:14px}
    .row{display:flex;gap:14px;align-items:stretch}
    .col{flex:1;min-width:0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e8edf2;font-size:15px;box-sizing:border-box;background:#fbfdff}
    .controls{margin-top:16px;display:flex;gap:12px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:0;padding:10px 16px;border-radius:9px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(10,107,255,.14)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .link{color:var(--blue);text-decoration:none;margin-left:6px;font-weight:600}
    .message{margin-top:12px;font-weight:600}
    .message.ok{color:var(--ok)}
    .message.err{color:var(--danger)}
    .small{font-size:13px;color:var(--muted);margin-top:14px}
    .result{margin-top:18px;border-radius:12px;padding:18px;border:1px solid #eef2f5;background:#ffffff}
    .result-grid{display:grid;grid-template-columns:1fr 260px;gap:12px}
    .left-dl dt{font-weight:700;color:#222;margin-top:6px}
    .left-dl dd{margin:2px 0 8px 0;color:#333}
    .badge{display:inline-block;padding:8px 12px;border-radius:12px;background:#eef6ff;color:var(--accent);font-weight:700;border:1px solid rgba(10,62,168,.06)}
    .field-title{font-size:12px;color:var(--muted);margin-top:8px}
    footer{margin-top:28px;text-align:center;color:var(--muted);font-size:13px}
    @media (max-width:820px){
      .result-grid{grid-template-columns:1fr;gap:12px}
      .row{flex-direction:column}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <header>
      <img src="header.png" alt="BA Information Technology Services" />
    </header>

    <div class="card" aria-labelledby="pageTitle">
      <h1 id="pageTitle">Follow-up Ticket Status</h1>
      <p class="hint">Enter the <strong>Complete name</strong> you used in the form and your <strong>Ticket number</strong> (e.g. BA-0053).</p>

      <div class="row" aria-hidden="false">
        <div class="col">
          <label for="clientName">Complete name (from the form)</label>
          <input id="clientName" type="text" placeholder="e.g. Juan Dela Cruz" autocomplete="name"/>
        </div>
        <div class="col" style="flex:0 0 260px">
          <label for="ticketNumber">Ticket number</label>
          <input id="ticketNumber" type="text" placeholder="e.g. BA-0053" autocomplete="off"/>
        </div>
      </div>

      <div class="controls">
        <button id="checkBtn" class="btn" aria-live="polite">Check Ticket</button>
        <a id="submitFormLink" class="link" href="https://forms.gle/QrGB6FrsphuRS8Bo9" target="_blank" rel="noopener">Submit a Concern</a>
        <div style="flex:1"></div>
      </div>

      <div id="message" class="message" aria-live="polite"></div>

      <div id="ticketArea" aria-live="polite"></div>

      <p class="small" style="display:none" id="legacyNote">Note: this page reads the published CSV of the Tickets sheet (hidden).</p>
    </div>

    <footer>BA Information Technology Services</footer>
  </div>

<script>
(() => {
  // ---------- CONFIG ----------
  const PUBLISHED_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfRBiFS4R36jzmtv0eMcVEkpqxpgNoI_dJ0DQRUO-lJ_Un_dYNqmYbl0agA4l7V9565ECHuvKKzMM1/pub?gid=60269729&single=true&output=csv';
  const MAX_ATTEMPTS = 5;
  const LOCKOUT_MS = 3 * 60 * 60 * 1000; // 3 hours
  const ATTEMPT_STORE_KEY = 'ba_ticket_attempts_v1'; // localStorage key
  // -----------------------------

  const clientNameEl = document.getElementById('clientName');
  const ticketNumberEl = document.getElementById('ticketNumber');
  const checkBtn = document.getElementById('checkBtn');
  const messageEl = document.getElementById('message');
  const ticketArea = document.getElementById('ticketArea');

  checkBtn.addEventListener('click', onCheck);
  ticketNumberEl.addEventListener('keydown', e => { if(e.key === 'Enter') onCheck(); });
  clientNameEl.addEventListener('keydown', e => { if(e.key === 'Enter') onCheck(); });

  function setMessage(text, type){ // type: 'ok' | 'err' | null
    messageEl.textContent = text || '';
    messageEl.className = 'message' + (type ? (type === 'ok'? ' ok': ' err') : '');
  }

  function normalize(s){ if(s===null||s===undefined) return ''; return String(s).trim().toLowerCase(); }

  // localStorage helpers for attempts
  function loadAttempts(){
    try {
      const raw = localStorage.getItem(ATTEMPT_STORE_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch (e) { return {}; }
  }
  function saveAttempts(obj){
    try { localStorage.setItem(ATTEMPT_STORE_KEY, JSON.stringify(obj)); } catch(e){}
  }
  function getAttemptKey(name, ticket){
    return 'k|' + normalize(name) + '|' + normalize(ticket);
  }

  function isLocked(name, ticket){
    const attempts = loadAttempts();
    const key = getAttemptKey(name,ticket);
    const data = attempts[key];
    if(!data) return false;
    if(data.lockedUntil && Date.now() < data.lockedUntil) return {locked:true, until:data.lockedUntil};
    return false;
  }

  function recordFailure(name, ticket){
    const attempts = loadAttempts();
    const key = getAttemptKey(name,ticket);
    const now = Date.now();
    let data = attempts[key] || { count:0, firstAt: now, lockedUntil: null };
    // reset if firstAt older than LOCKOUT_MS*2 to avoid forever accumulation
    if(now - (data.firstAt || 0) > LOCKOUT_MS * 24) { data = { count:0, firstAt: now, lockedUntil: null }; }
    data.count = (data.count || 0) + 1;
    if(data.count >= MAX_ATTEMPTS){
      data.lockedUntil = now + LOCKOUT_MS;
    }
    attempts[key] = data;
    saveAttempts(attempts);
    return data;
  }

  function clearAttempts(name, ticket){
    const attempts = loadAttempts();
    const key = getAttemptKey(name,ticket);
    if(attempts[key]){ delete attempts[key]; saveAttempts(attempts); }
  }

  // --- main handler
  async function onCheck(){
    setMessage('',null); ticketArea.innerHTML = '';
    const name = (clientNameEl.value || '').trim();
    const ticket = (ticketNumberEl.value || '').trim();
    if(!name || !ticket){ setMessage('Please enter both name and ticket number.', 'err'); return; }

    // check for local lockout
    const locked = isLocked(name,ticket);
    if(locked && locked.locked){
      const until = new Date(locked.until);
      setMessage(`Too many failed attempts. You can try again after ${until.toLocaleString()}.`, 'err');
      return;
    }

    checkBtn.disabled = true;
    setMessage('Fetching tickets...', null);
    try {
      const csvText = await fetchCsv(PUBLISHED_CSV);
      const { headerMap, rows } = parseCsvToRows(csvText);

      if(rows.length === 0) throw new Error('empty-csv');

      // header detection (tolerant)
      const col = {
        ticket: findHeader(headerMap, ['ticket','ticket number','ticket_no','ticket id','ticket id']),
        clientName: findHeader(headerMap, ['client name','clientname','name','complete name','full name']),
        timestamp: findHeader(headerMap, ['timestamp','submitted','submitted at','date']),
        submitterEmail: findHeader(headerMap, ['submitter email','email','email address','submitter_email']),
        location: findHeader(headerMap, ['location','service location','address']),
        priority: findHeader(headerMap, ['priority']),
        concern: findHeader(headerMap, ['concern','issue','description','type of request']),
        status: findHeader(headerMap, ['status','st','state']),
        assigned: findHeader(headerMap, ['assigned to','assigned','assigned_to','assignedto']),
        resolvedAt: findHeader(headerMap, ['resolved at','resolved_at','resolved']),
        lastUpdated: findHeader(headerMap, ['last updated','last_updated','lastupdated','last update','lastupdate'])
      };

      if(col.ticket === -1 || col.clientName === -1){
        throw new Error('missing-columns');
      }

      const tNorm = normalize(ticket);
      let matchRow = null;
      for(const r of rows){
        const rTicket = normalize(r[col.ticket] || '');
        if(rTicket === tNorm){
          // ticket found; check name match
          const rName = normalize(r[col.clientName] || '');
          if(rName === normalize(name)){
            matchRow = r; break;
          } else {
            // ticket found but name mismatch -> failure attempt
            const data = recordFailure(name,ticket);
            if(data.lockedUntil){
              const until = new Date(data.lockedUntil);
              setMessage(`Too many failed attempts. You can try again after ${until.toLocaleString()}.`, 'err');
            } else {
              setMessage('Ticket number found but the name does not match the name on the ticket. Use the exact name from the form (case-insensitive).', 'err');
            }
            return;
          }
        }
      }

      if(!matchRow){
        const data = recordFailure(name,ticket);
        if(data.lockedUntil){
          const until = new Date(data.lockedUntil);
          setMessage(`Too many failed attempts. You can try again after ${until.toLocaleString()}.`, 'err');
        } else {
          const remaining = Math.max(0, MAX_ATTEMPTS - (data.count || 0));
          setMessage(`No matching ticket found. Attempts remaining: ${remaining}`, 'err');
        }
        return;
      }

      // success: clear attempts for this key
      clearAttempts(name,ticket);

      // Render ticket details
      const get = (idx) => (idx >= 0 ? (matchRow[idx] || '') : '');

      const statusText = escapeHtml(get(col.status) || '');
      const lastUpdatedText = escapeHtml(get(col.lastUpdated) || '');

      const html = `
        <div class="result">
          <div class="result-grid">
            <div>
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="field-title">Ticket</div>
                  <div style="font-weight:700;font-size:16px">${escapeHtml(get(col.ticket))}</div>
                  <div class="field-title" style="margin-top:10px">Client</div>
                  <div style="font-size:15px">${escapeHtml(get(col.clientName))}</div>
                </div>
                <div style="text-align:right">
                  <div class="badge">${statusText || 'Unknown'}</div>
                  ${ lastUpdatedText ? `<div style="margin-top:8px;font-size:12px;color:var(--muted)">Last Updated<br><strong>${lastUpdatedText}</strong></div>` : '' }
                </div>
              </div>

              <hr style="margin:12px 0;border:none;border-top:1px solid #f1f4f8">

              <dl class="left-dl">
                <dt>Submitted</dt><dd>${escapeHtml(get(col.timestamp) || '')}</dd>
                <dt>Email</dt><dd>${escapeHtml(get(col.submitterEmail) || '')}</dd>
                <dt>Location</dt><dd>${escapeHtml(get(col.location) || '')}</dd>
                <dt>Priority</dt><dd>${escapeHtml(get(col.priority) || '')}</dd>
                <dt>Concern</dt><dd>${escapeHtml(get(col.concern) || '')}</dd>
              </dl>
            </div>

            <div>
              <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Assigned to</div>
              <div style="font-size:15px;margin-bottom:12px">${escapeHtml(get(col.assigned) || '')}</div>

              <div style="font-weight:700;color:var(--muted);margin-bottom:8px">Resolved at</div>
              <div style="font-size:15px">${escapeHtml(get(col.resolvedAt) || '')}</div>

              <!-- future: more staff-only info could go here (not shown to client) -->
            </div>
          </div>
        </div>
      `;

      ticketArea.innerHTML = html;
      setMessage('Ticket loaded.', 'ok');

    } catch (err){
      console.error(err);
      const code = (err && err.message) ? err.message : '';
      if(code === 'empty-csv'){
        setMessage('The published sheet returned an empty CSV. Confirm you published the correct Tickets sheet tab.', 'err');
      } else if(code === 'missing-columns'){
        setMessage('The Tickets CSV is missing required columns (Ticket or Client Name).', 'err');
      } else if(code === 'server-returned-html'){
        setMessage('The published link returned HTML instead of CSV. Re-publish the sheet to the web and try again.', 'err');
      } else {
        setMessage('Error fetching tickets: ' + (err && err.message ? err.message : String(err)), 'err');
      }
    } finally {
      checkBtn.disabled = false;
    }
  }

  // fetch CSV text and do a quick validation: if HTML seems returned, throw special error
  async function fetchCsv(url){
    const res = await fetch(url, { cache: 'no-store', credentials: 'omit' });
    if(!res.ok) throw new Error('Network error: ' + res.status);
    const text = await res.text();
    const trimmed = text.trim();
    if(trimmed.startsWith('<') || trimmed.toLowerCase().includes('<!doctype html') || trimmed.toLowerCase().includes('<html')){
      // HTML returned -> publish issue
      const e = new Error('server-returned-html');
      throw e;
    }
    return text;
  }

  // parse CSV into headerMap and rows (arrays)
  function parseCsvToRows(csvText){
    // Simple CSV parse that handles quoted fields.
    const rows = [];
    let cur = '', inQuotes = false, row = [], i=0;
    while(i < csvText.length){
      const ch = csvText[i];
      if(inQuotes){
        if(ch === '"'){
          if(csvText[i+1] === '"'){ cur += '"'; i+=2; continue; }
          inQuotes = false; i++; continue;
        } else {
          cur += ch; i++; continue;
        }
      } else {
        if(ch === '"'){ inQuotes = true; i++; continue; }
        if(ch === ','){ row.push(cur); cur = ''; i++; continue; }
        if(ch === '\r'){ i++; continue; }
        if(ch === '\n'){ row.push(cur); rows.push(row); row = []; cur = ''; i++; continue; }
        cur += ch; i++;
      }
    }
    // leftover
    if(cur !== '' || row.length){
      row.push(cur);
      rows.push(row);
    }

    if(rows.length === 0) return { headerMap: {}, rows: [] };

    const headers = rows[0].map(h => String(h||'').trim());
    const headerMap = {};
    for(let j=0;j<headers.length;j++){
      headerMap[normalize(headers[j])] = j;
    }
    const dataRows = rows.slice(1);
    return { headerMap, rows: dataRows };
  }

  function findHeader(headerMap, candidates){
    for(const c of candidates){
      const k = normalize(c);
      if(k in headerMap) return headerMap[k];
    }
    // try substring fallback
    for(const key in headerMap){
      for(const c of candidates){
        if(key.indexOf(normalize(c)) !== -1) return headerMap[key];
      }
    }
    return -1;
  }

  function escapeHtml(s){
    return String(s || '').replace(/[&<>"']/g, (c)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[c]);
  }

})();
</script>
</body>
</html>
