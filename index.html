<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Follow-up Ticket Status – BA IT</title>
  <meta name="description" content="Check your BA support ticket by ticket number and name.">
  <style>
    :root{--blue:#0a6bff;--muted:#6c7680;--bg:#f5f7fb;--card:#ffffff}
    body{margin:0;background:var(--bg);font-family:Inter,Arial,Helvetica,sans-serif;color:#111}
    .wrap{max-width:920px;margin:18px auto;padding:18px}
    .header-img{width:100%;border-radius:12px;margin-bottom:18px;object-fit:cover}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(10,20,40,.06)}
    h1{margin:0 0 8px 0;font-size:22px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .grid{display:grid;grid-template-columns:1fr 260px;gap:12px;margin-bottom:12px}
    input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eaf0;font-size:15px}
    .btn{background:var(--blue);color:#fff;border:0;padding:10px 14px;border-radius:9px;font-weight:700;cursor:pointer}
    .link{font-size:14px;color:var(--blue);margin-left:10px;text-decoration:none;font-weight:600}
    .error{margin-top:14px;color:#c62828;font-size:14px;font-weight:600}
    .ticket-box{margin-top:18px;padding:16px;border-radius:10px;background:#fff;border:1px solid #e8e8e8}
    .row{margin-bottom:8px;font-size:15px}
    .label{font-weight:700;color:#333}
    .status-pill{display:inline-block;padding:6px 12px;border-radius:8px;font-size:13px;font-weight:700;color:#fff}
    .pending{background:#6c7680}.reviewing{background:#0a6bff}.clarifying{background:#ca8a04}.failed{background:#d32f2f}.succeeded{background:#2e7d32}
    .muted{color:#6c7680;font-size:13px;margin-top:6px}
    .small{font-size:13px;color:#6c7680}
    footer{margin-top:28px;text-align:center;color:#9aa0a6;font-size:13px}
    code.debug{display:block;white-space:pre-wrap;background:#fff;padding:10px;border-radius:6px;margin-top:12px;border:1px solid #eee}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- header.png must exist in repo root -->
    <img src="header.png" alt="BA Information Technology Services" class="header-img">

    <div class="card" role="main" aria-labelledby="title">
      <h1 id="title">Follow-up Ticket Status</h1>
      <p class="small">Enter the <strong>Complete name</strong> you used in the form and your <strong>Ticket number</strong> (e.g. <em>BA-0053</em>).</p>

      <div class="grid">
        <div>
          <label for="name">Complete name (from the form)</label>
          <input id="name" type="text" placeholder="Your complete name">
        </div>
        <div>
          <label for="ticket">Ticket number</label>
          <input id="ticket" type="text" placeholder="BA-0001">
        </div>
      </div>

      <button class="btn" id="checkBtn">Check Ticket</button>
      <a class="link" href="https://forms.gle/QrGB6FrsphuRS8Bo9" target="_blank" rel="noopener">Submit a Concern</a>

      <div id="error" class="error" role="alert" aria-live="polite"></div>
      <div id="result" aria-live="polite"></div>
      <div id="debug" class="muted" style="display:none"></div>
    </div>

    <footer>BA Information Technology Services</footer>
  </div>

  <script>
    // Public spreadsheet endpoint for Tickets sheet (gviz JSON wrapper)
    const sheetURL = "https://docs.google.com/spreadsheets/d/13fetKChhGys7GOBHwGsOMU5TDJqgiFfmPUIQUeYmfoQ/gviz/tq?tqx=out:json&sheet=Tickets";

    const errorEl = document.getElementById('error');
    const resultEl = document.getElementById('result');
    const debugEl = document.getElementById('debug');
    const btn = document.getElementById('checkBtn');

    btn.addEventListener('click', checkTicket);

    function normalizeName(s){
      return String(s||'').trim().replace(/\s+/g,' ').toLowerCase();
    }
    function normalizeTicketRaw(s){
      return String(s||'').replace(/\D/g,'');
    }

    // Given parsed gviz JSON, provide column indices based on headers or fixed layout
    function pickColumns(parsed){
      // If headers available, use them
      const cols = (parsed.table && parsed.table.cols) ? parsed.table.cols : [];
      const labels = cols.map(c => (String(c && c.label || '').toLowerCase().trim()));

      // default layout (as per your sheet screenshots)
      const defaults = {
        ticket: 0,
        timestamp: 1,
        submitterEmail: 2,
        clientName: 3,     // D
        location: 4,       // E
        priority: 5,
        concern: 6,        // G
        status: 7,         // H
        assigned: 8,       // I
        resolvedAt: 9,     // J
        internalNote: 10,  // K (do not show to clients)
        formRowId: 11,
        responseLink: 12,
        lastUpdated: 13
      };

      // helper to find label by keywords
      function findIndexByKeywords(words){
        for (let i=0;i<labels.length;i++){
          for (let w of words){
            if (!labels[i]) continue;
            if (labels[i].includes(w)) return i;
          }
        }
        return -1;
      }

      // Try header detection first (more robust)
      const ticketIdx = findIndexByKeywords(['ticket']) !== -1 ? findIndexByKeywords(['ticket']) : defaults.ticket;
      const nameIdx = findIndexByKeywords(['client name','full name','name','submitter']) !== -1 ? findIndexByKeywords(['client name','full name','name','submitter']) : defaults.clientName;
      const statusIdx = findIndexByKeywords(['status','state']) !== -1 ? findIndexByKeywords(['status','state']) : defaults.status;
      const concernIdx = findIndexByKeywords(['concern','issue','description','type']) !== -1 ? findIndexByKeywords(['concern','issue','description','type']) : defaults.concern;
      const assignedIdx = findIndexByKeywords(['assign','assigned to','assignee']) !== -1 ? findIndexByKeywords(['assign','assigned to','assignee']) : defaults.assigned;
      const locationIdx = findIndexByKeywords(['location','address','service location']) !== -1 ? findIndexByKeywords(['location','address','service location']) : defaults.location;
      const resolvedIdx = findIndexByKeywords(['resolved','resolved at','date resolved']) !== -1 ? findIndexByKeywords(['resolved','resolved at','date resolved']) : defaults.resolvedAt;
      const lastUpdatedIdx = findIndexByKeywords(['last updated','last update','updated']) !== -1 ? findIndexByKeywords(['last updated','last update','updated']) : defaults.lastUpdated;
      const responseLinkIdx = findIndexByKeywords(['response link','follow','follow-up','response link']) !== -1 ? findIndexByKeywords(['response link','follow','follow-up','response link']) : defaults.responseLink;

      return {
        ticket: ticketIdx,
        name: nameIdx,
        status: statusIdx,
        concern: concernIdx,
        assigned: assignedIdx,
        location: locationIdx,
        resolvedAt: resolvedIdx,
        lastUpdated: lastUpdatedIdx,
        responseLink: responseLinkIdx
      };
    }

    async function checkTicket(){
      errorEl.textContent = '';
      resultEl.innerHTML = '';
      debugEl.style.display = 'none';
      debugEl.textContent = '';

      const nameInRaw = document.getElementById('name').value;
      const ticketInRaw = document.getElementById('ticket').value.trim();

      const nameIn = normalizeName(nameInRaw);
      const ticketNumeric = normalizeTicketRaw(ticketInRaw);

      if (!nameIn || !ticketNumeric){
        errorEl.textContent = 'Please enter both name and ticket number (e.g. BA-0016).';
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Checking…';

      try {
        const res = await fetch(sheetURL, {cache: "no-store"});
        const text = await res.text();

        // If HTML error (Drive or not accessible)
        if (/google drive|sorry unable to open the file|page not found|403|404|<!doctype html>/i.test(text)){
          errorEl.textContent = 'The Tickets sheet could not be fetched. Make sure the sheet is shared "Anyone with the link — Viewer".';
          debugEl.style.display = 'block';
          debugEl.textContent = 'Server returned HTML or error page. Confirm sharing and that the URL is correct.';
          btn.disabled = false;
          btn.textContent = 'Check Ticket';
          return;
        }

        // extract JSON object inside wrapper
        const firstBrace = text.indexOf('{');
        const lastBrace = text.lastIndexOf('}');
        if (firstBrace === -1 || lastBrace === -1 || lastBrace <= firstBrace){
          errorEl.textContent = 'Unexpected response format from the Tickets sheet.';
          debugEl.style.display = 'block';
          debugEl.textContent = text.slice(0,800);
          btn.disabled = false;
          btn.textContent = 'Check Ticket';
          return;
        }
        const jsonStr = text.substring(firstBrace, lastBrace + 1);
        let parsed;
        try { parsed = JSON.parse(jsonStr); } catch (e){
          errorEl.textContent = 'Error parsing sheet data (invalid JSON).';
          debugEl.style.display = 'block';
          debugEl.textContent = 'JSON parse error: ' + (e && e.message) + '\n\nPreview:\n' + jsonStr.slice(0,800);
          btn.disabled = false;
          btn.textContent = 'Check Ticket';
          return;
        }

        const rows = (parsed.table && parsed.table.rows) ? parsed.table.rows : [];
        const plainRows = rows.map(r => (r.c||[]).map(c => (c && (typeof c.v !== 'undefined') ? c.v : '')));

        // choose columns (prefer explicit layout but try headers)
        const cols = pickColumns(parsed);

        // Search for match: ticket number numeric and normalized name in clientName column (col D / index 3)
        let found = null;
        for (let r of plainRows){
          const sheetTicketRaw = String(r[cols.ticket] || '');
          const sheetTicketNumeric = normalizeTicketRaw(sheetTicketRaw);
          const sheetNameRaw = String(r[cols.name] || '');
          const sheetName = normalizeName(sheetNameRaw);
          if (sheetTicketNumeric && sheetTicketNumeric === ticketNumeric && sheetName === nameIn){
            found = r;
            break;
          }
        }

        if (!found){
          // detect whether ticket exists with different name
          let ticketExists = false;
          for (let r of plainRows){
            const st = normalizeTicketRaw(String(r[cols.ticket] || ''));
            if (st === ticketNumeric){ ticketExists = true; break; }
          }
          if (ticketExists){
            errorEl.textContent = 'Ticket found but the name does not match. Use the exact full name you entered in the form (spacing and case are tolerant).';
          } else {
            errorEl.textContent = 'No matching ticket found. Double-check the ticket number and name in your confirmation email.';
          }
          btn.disabled = false;
          btn.textContent = 'Check Ticket';
          return;
        }

        // Gather fields using chosen indices
        function getField(row, idx){ return (idx >= 0) ? (row[idx] || '') : ''; }
        const ticketDisplay = getField(found, cols.ticket);
        const clientName = getField(found, cols.name);
        const location = getField(found, cols.location);
        const concern = getField(found, cols.concern);
        const status = getField(found, cols.status) || 'Pending';
        const assigned = getField(found, cols.assigned) || '—';
        const resolvedAt = getField(found, cols.resolvedAt) || '—';
        const lastUpdated = getField(found, cols.lastUpdated) || '—';
        const responseLink = getField(found, cols.responseLink) || '';

        // status pill
        let badgeClass = 'pending';
        const s = String(status || '').toLowerCase();
        if (s.includes('review')) badgeClass='reviewing';
        else if (s.includes('clar') || s.includes('clarify')) badgeClass='clarifying';
        else if (s.includes('fail')) badgeClass='failed';
        else if (s.includes('succ')) badgeClass='succeeded';

        // Build client-visible details (do NOT include internal note column)
        resultEl.innerHTML = `
          <div class="ticket-box" role="region" aria-label="Ticket details">
            <div class="row"><span class="label">Ticket:</span> ${escapeHtml(ticketDisplay)}</div>
            <div class="row"><span class="label">Name:</span> ${escapeHtml(clientName)}</div>
            <div class="row"><span class="label">Location:</span> ${escapeHtml(location)}</div>
            <div class="row"><span class="label">Concern:</span> ${escapeHtml(concern)}</div>
            <div class="row"><span class="label">Assigned To:</span> ${escapeHtml(assigned)}</div>
            <div class="row"><span class="label">Status:</span> <span class="status-pill ${badgeClass}">${escapeHtml(status)}</span></div>
            <div class="row"><span class="label">Resolved At:</span> ${escapeHtml(resolvedAt)}</div>
            <div class="row"><span class="label">Last Updated:</span> ${escapeHtml(lastUpdated)}</div>
            ${ responseLink ? `<div class="row"><a href="${escapeHtml(responseLink)}" target="_blank" rel="noopener">Follow-up Ticket Status link</a></div>` : '' }
          </div>
        `;
      } catch (err){
        errorEl.textContent = 'Unexpected error while fetching tickets.';
        debugEl.style.display = 'block';
        debugEl.textContent = (err && err.message) ? err.message : String(err);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Check Ticket';
      }
    }

    function escapeHtml(s){
      return String(s||'').replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch]));
    }
  </script>
</body>
</html>
