<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Follow-up Ticket Status — BA Information Technology Services</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#0a6bff;
      --purple:#7c3aed;
      --brown:#a16207;
      --red:#d93025;
      --green:#16a34a;
      --muted:#6c7680;
      --card:#ffffff;
      --bg:#f4f6fb;
      --maxw:920px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Inter,Arial,Helvetica,sans-serif;
      background:var(--bg);
      color:#111;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .page{
      max-width:var(--maxw);
      margin:28px auto;
      padding:0 18px;
    }
    .header-wrap{
      background:transparent;
      display:flex;
      justify-content:center;
      margin-bottom:8px;
    }
    .header-wrap img{
      width:100%;
      max-width:900px;
      height:auto;
      border-radius:6px;
      box-shadow:0 6px 28px rgba(10,20,40,0.06);
      display:block;
    }
    .faq-row{
      text-align:center;
      margin:8px 0 18px;
    }
    .faq-row a{
      color:var(--blue);
      text-decoration:none;
      font-weight:700;
      font-size:15px;
      padding:6px 10px;
      border-radius:6px;
    }
    .faq-row a:hover{ text-decoration:underline; }
    .card{
      background:var(--card);
      border-radius:14px;
      padding:22px;
      box-shadow:0 10px 28px rgba(12,24,48,0.06);
    }
    h1{
      margin:0 0 6px 0;
      font-size:20px;
      color:#0e2460;
    }
    .hint{
      color:var(--muted);
      font-size:14px;
      margin-bottom:14px;
    }
    .grid{
      display:grid;
      grid-template-columns:1fr 280px;
      gap:14px;
      align-items:start;
    }
    label{ display:block; font-weight:600; color:#333; font-size:13px; margin-bottom:6px; }
    input[type="text"]{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid #e6e9ef;
      font-size:14px;
      outline:none;
    }
    input[type="text"]:focus{ box-shadow:0 0 0 4px rgba(10,107,255,0.08); border-color:var(--blue); }
    .actions{
      margin-top:14px;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .btn{
      display:inline-block;
      background:var(--blue);
      color:#fff;
      padding:10px 16px;
      border-radius:10px;
      font-weight:700;
      text-decoration:none;
      border:none;
      cursor:pointer;
    }
    .btn.secondary{
      background:transparent;
      color:var(--blue);
      font-weight:700;
      text-decoration:underline;
      padding:0;
      border:0;
      cursor:pointer;
    }
    .msg{
      margin-top:12px;
      font-weight:700;
      color:#0a6b2a;
    }
    .error{
      margin-top:12px;
      font-weight:700;
      color:var(--red);
    }
    .ticket{
      margin-top:20px;
      background:#fbfdff;
      border-radius:10px;
      border:1px solid #e8eef7;
      padding:18px;
    }
    .ticket .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:14px;
    }
    .ticket .left{flex:1; min-width:0}
    .ticket .right{width:240px; text-align:right}
    .label{ font-weight:700; color:#25304a; margin-bottom:8px; display:block }
    .value{ color:#1a2438; font-size:15px; margin-bottom:12px; line-height:1.4; min-height:18px }
    .status-chip{
      display:inline-block;
      padding:8px 12px;
      border-radius:12px;
      color:#fff;
      font-weight:800;
      font-size:13px;
      text-transform:none;
      box-shadow:0 6px 18px rgba(10,20,40,0.05);
    }
    .pending { background:var(--blue); }
    .reviewing { background:var(--purple); }
    .clarification { background:var(--brown); }
    .failed { background:var(--red); }
    .succeeded { background:var(--green); }
    .meta {
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
    }
    footer {
      text-align:center;
      margin:28px 0 80px 0;
      color:#b6bec7;
      font-size:13px;
    }
    .lockout-note { color:var(--muted); font-size:13px; margin-top:8px; }
    @media (max-width:820px){
      .grid{ grid-template-columns:1fr; }
      .ticket .right{ text-align:left; width:auto; margin-top:12px }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header-wrap">
      <img src="header.png" alt="BA Information Technology Services">
    </div>

    <div class="faq-row">
      <a href="https://script.google.com/macros/s/AKfycbwCinvx9cDyEk5J8wckWNbaikP7lL_J08R-HTVC2QUUfD2nYf-BDWRjdQcddcXJor8LOA/exec"
         target="_blank" rel="noopener">
        Frequently Asked Questions (FAQs)
      </a>
    </div>

    <div class="card">
      <h1>Follow-up Ticket Status</h1>
      <div class="hint">Enter the <strong>Complete name</strong> you used in the form and your <strong>Ticket number</strong> (e.g. BA-0053).</div>

      <div class="grid">
        <div>
          <label>Complete name (from the form)</label>
          <input id="clientName" type="text" placeholder="Type full name exactly as submitted">

          <label style="margin-top:12px">Ticket number</label>
          <input id="ticketNumber" type="text" placeholder="e.g. BA-0016">
          
          <div class="actions">
            <button class="btn" id="checkBtn">Check Ticket</button>
            <a class="btn secondary" href="https://forms.gle/QrGB6FrsphuRS8Bo9" target="_blank" rel="noopener">Submit a Concern</a>
          </div>

          <div id="msg" class="msg" style="display:none">Ticket loaded.</div>
          <div id="err" class="error" style="display:none"></div>
          <div id="lockNote" class="lockout-note" style="display:none"></div>
        </div>

        <div>
          <!-- right column placeholder -->
        </div>
      </div>

      <div id="ticketArea" class="ticket" style="display:none"></div>
    </div>

    <footer>BA Information Technology Services</footer>
  </div>

<script>
/* CONFIG */
const TICKET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfRBiFS4R36jzmtv0eMcVEkpqxpgNoI_dJ0DQRUO-lJ_Un_dYNqmYbl0agA4l7V9565ECHuvKKzMM1/pub?gid=60269729&single=true&output=csv";
const MAX_ATTEMPTS = 5;
const LOCKOUT_MS = 3 * 60 * 60 * 1000;

function normalize(v){ return String(v||'').trim().toLowerCase(); }
function mapStatusClass(status){
  const s = normalize(status);
  if(s.includes('pending')) return 'pending';
  if(s.includes('review')) return 'reviewing';
  if(s.includes('clar')) return 'clarification';
  if(s.includes('fail')) return 'failed';
  if(s.includes('succeed') || s.includes('success')) return 'succeeded';
  return 'pending';
}

function parseCsv(text){
  const rows = [];
  let cur = [];
  let curField = '';
  let inQuotes = false;
  for(let i=0;i<text.length;i++){
    const ch = text[i];
    if(inQuotes){
      if(ch === '"'){
        if(text[i+1] === '"'){ curField += '"'; i++; } else { inQuotes = false; }
      } else {
        curField += ch;
      }
    } else {
      if(ch === '"'){ inQuotes = true; }
      else if(ch === ','){ cur.push(curField); curField = ''; }
      else if(ch === '\r'){
      } else if(ch === '\n'){
        cur.push(curField); rows.push(cur); cur = []; curField = '';
      } else { curField += ch; }
    }
  }
  if(curField !== '' || cur.length > 0){ cur.push(curField); rows.push(cur); }
  return rows.filter(r => r.join('').trim().length > 0);
}

function parseHtmlTableToRows(htmlText){
  try {
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlText, 'text/html');
    const tbl = doc.querySelector('table');
    if(!tbl) return null;
    const rows = [];
    for(const tr of tbl.rows){
      const cols = [];
      for(const td of tr.cells){
        cols.push(td.textContent.trim());
      }
      rows.push(cols);
    }
    return rows.length ? rows : null;
  } catch(e){
    return null;
  }
}

async function fetchTicketsRawRows(){
  try {
    const r = await fetch(TICKET_CSV_URL, {cache: 'no-store'});
    if(!r.ok) throw new Error('fetch_failed');
    const txt = await r.text();
    if(/<\s*html/i.test(txt) || /<\s*table/i.test(txt)){
      const tableRows = parseHtmlTableToRows(txt);
      if(tableRows && tableRows.length) return tableRows;
    }
    const parsed = parseCsv(txt);
    if(parsed && parsed.length) return parsed;
    throw new Error('no_rows');
  } catch(err){
    try {
      const alt = TICKET_CSV_URL.replace(/output=csv/i, 'single=true').replace(/\?$/,'');
      const r2 = await fetch(alt, {cache: 'no-store'});
      if(r2.ok){
        const txt2 = await r2.text();
        const tableRows = parseHtmlTableToRows(txt2);
        if(tableRows && tableRows.length) return tableRows;
      }
    } catch(e){}
    throw err;
  }
}

/* LOCKOUT */
function lockKey(name, ticket){ return 'lock|' + (String(name||'').trim().toLowerCase()) + '|' + (String(ticket||'').trim().toLowerCase()); }
function getLockEntry(name, ticket){
  const key = lockKey(name,ticket);
  try { const raw = localStorage.getItem(key); if(!raw) return { attempts:0, blockedUntil:0 }; return JSON.parse(raw); } catch(e){ return { attempts:0, blockedUntil:0 }; }
}
function setLockEntry(name, ticket, entry){ try { localStorage.setItem(lockKey(name,ticket), JSON.stringify(entry)); } catch(e){} }
function registerAttempt(name, ticket){
  const e = getLockEntry(name,ticket);
  const now = Date.now();
  if(e.blockedUntil && e.blockedUntil > now){
    return { allowed:false, attemptsLeft:0, blockedUntil: e.blockedUntil };
  }
  e.attempts = (e.attempts || 0) + 1;
  if(e.attempts >= MAX_ATTEMPTS){
    e.blockedUntil = now + LOCKOUT_MS;
  }
  setLockEntry(name,ticket,e);
  return { allowed: e.blockedUntil ? false : true, attemptsLeft: Math.max(0, MAX_ATTEMPTS - e.attempts), blockedUntil: e.blockedUntil || 0 };
}

function displayError(msg){
  const e = document.getElementById('err');
  e.style.display = 'block';
  e.textContent = msg;
  document.getElementById('msg').style.display = 'none';
  document.getElementById('ticketArea').style.display='none';
  document.getElementById('lockNote').style.display='none';
}
function displaySuccess(){ document.getElementById('err').style.display='none'; document.getElementById('msg').style.display='block'; }
function dash(s){ return (s === undefined || s === null || String(s).trim() === '') ? '-' : String(s); }

function renderTicket(found){
  const box = document.getElementById('ticketArea');
  box.style.display = 'block';
  const statusClass = mapStatusClass(found.status);
  const submitted = dash(found.timestamp);
  const location = dash(found.location);
  const concern = dash(found.concern);
  const assigned = dash(found.assigned);
  const resolvedAt = dash(found.resolved);
  const notes = dash(found.internal);
  const lastUpdated = dash(found.lastUpdated);

  box.innerHTML = `
    <div class="row">
      <div class="left">
        <div><span class="label">Ticket</span><div class="value"><strong>${dash(found.ticket)}</strong></div></div>
        <div><span class="label">Client</span><div class="value">${dash(found.client)}</div></div>
        <div><span class="label">Submitted</span><div class="value">${submitted}</div></div>
        <div><span class="label">Service Location</span><div class="value">${location}</div></div>
        <div><span class="label">Concern</span><div class="value">${concern}</div></div>
        <div><span class="label">Internal Notes</span><div class="value">${notes}</div></div>
      </div>
      <div class="right">
        <div style="text-align:right;">
          <div class="status-chip ${statusClass}">${dash(found.status)}</div>
        </div>
        <div style="height:12px"></div>
        <div><span class="label">Assigned to</span><div class="value">${assigned}</div></div>
        <div><span class="label">Resolved at</span><div class="value">${resolvedAt}</div></div>
        <div><span class="label">Last Updated</span><div class="meta">${lastUpdated}</div></div>
      </div>
    </div>
  `;
}

/* header detection helpers */
function findHeaderIndex(headers, variants){
  const lowered = headers.map(h=> (h||'').toString().toLowerCase().trim());
  for(const v of variants){
    const i = lowered.indexOf(v);
    if(i !== -1) return i;
  }
  return -1;
}

document.getElementById('checkBtn').addEventListener('click', async function(){
  document.getElementById('err').style.display='none';
  document.getElementById('msg').style.display='none';
  document.getElementById('lockNote').style.display='none';

  const nameInput = document.getElementById('clientName').value || '';
  const ticketInput = document.getElementById('ticketNumber').value || '';
  const name = normalize(nameInput);
  const ticket = normalize(ticketInput);

  if(!name || !ticket){
    displayError('Please enter both the Complete name and Ticket number.');
    return;
  }

  const attemptRes = registerAttempt(name, ticket);
  if(!attemptRes.allowed){
    if(attemptRes.blockedUntil){
      const until = new Date(attemptRes.blockedUntil);
      displayError(`Too many attempts. This lookup is temporarily locked until ${until.toLocaleString()}.`);
      return;
    }
  }
  if(attemptRes.allowed && attemptRes.attemptsLeft !== undefined && attemptRes.attemptsLeft <= 2){
    const noteEl = document.getElementById('lockNote');
    noteEl.style.display = 'block';
    noteEl.textContent = `Attempts left: ${attemptRes.attemptsLeft}. After ${MAX_ATTEMPTS} wrong attempts this lookup is locked for 3 hours.`;
  }

  try {
    const rows = await fetchTicketsRawRows();
    if(!rows || rows.length < 2){
      displayError('No ticket data found. Confirm the Tickets sheet is published and accessible.');
      return;
    }

    const headerRow = rows[0].map(h => (h||'').toString().trim());
    // find indexes
    const idx_ticket = findHeaderIndex(headerRow, ['ticket','ticket number','ticket_no','ticket#']);
    const idx_timestamp = findHeaderIndex(headerRow, ['timestamp','submitted','submitted at','date','date submitted']);
    const idx_email = findHeaderIndex(headerRow, ['submitter email','email','submitteremail','submitter_email']);
    const idx_client = findHeaderIndex(headerRow, ['client name','client','clientname','name','complete name']);
    // IMPORTANT: prefer "service location" header; if not found fallback to column E (index 4)
    let idx_location = findHeaderIndex(headerRow, ['service location','service_location','location','address']);
    if(idx_location === -1 && headerRow.length >= 5){
      // column E fallback (index 4)
      idx_location = 4;
      console.info('Service Location header not found — falling back to column E (index 4).');
    }
    const idx_priority = findHeaderIndex(headerRow, ['priority']);
    const idx_concern = findHeaderIndex(headerRow, ['concern','issue','description']);
    const idx_status = findHeaderIndex(headerRow, ['status','state','st']);
    const idx_assigned = findHeaderIndex(headerRow, ['assigned to','assignedto','assigned']);
    const idx_resolved = findHeaderIndex(headerRow, ['resolved at','resolvedat','resolved']);
    const idx_internal = findHeaderIndex(headerRow, ['internal note','internal notes','internalnote']);
    const idx_lastupdated = findHeaderIndex(headerRow, ['last updated','lastupdated','last_updated','last update']);

    let found = null;
    for(let i=1;i<rows.length;i++){
      const r = rows[i];
      while(r.length < headerRow.length) r.push('');
      const rTicket = normalize(r[idx_ticket] || '');
      const rName = normalize(r[idx_client] || '');
      if(rTicket === ticket && rName === name){
        found = {
          ticket: r[idx_ticket] || '',
          timestamp: r[idx_timestamp] || '',
          email: r[idx_email] || '',
          client: r[idx_client] || '',
          location: (idx_location >=0 ? r[idx_location] : '') || '',
          priority: r[idx_priority] || '',
          concern: r[idx_concern] || '',
          status: r[idx_status] || '',
          assigned: r[idx_assigned] || '',
          resolved: r[idx_resolved] || '',
          internal: r[idx_internal] || '',
          lastUpdated: r[idx_lastupdated] || ''
        };
        break;
      }
    }

    if(!found){
      displayError('No matching ticket found. Make sure the name matches exactly the one in the form (case-insensitive) and the ticket number is correct.');
      return;
    }

    displaySuccess();
    renderTicket(found);

  } catch(err){
    console.error('Fetch/parse error', err);
    displayError('The Tickets sheet could not be fetched. Ensure the published URL is correct and publicly viewable.');
  }
});

document.getElementById('ticketNumber').addEventListener('keydown', function(e){
  if(e.key === 'Enter') document.getElementById('checkBtn').click();
});
document.getElementById('clientName').addEventListener('keydown', function(e){
  if(e.key === 'Enter') document.getElementById('checkBtn').click();
});
</script>
</body>
</html>
