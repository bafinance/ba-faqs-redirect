<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Follow-up Ticket Status — BA IT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#0a6bff;
      --muted:#6c7680;
      --bg:#f5f7fb;
      --card:#ffffff;
    }
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:920px;margin:28px auto;padding:18px}
    header{display:block;text-align:center;margin-bottom:14px}
    header img{width:100%;max-height:140px;object-fit:cover;border-radius:6px;box-shadow:0 6px 18px rgba(10,10,20,.06)}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(10,20,40,.06)}
    h1{margin:0 0 8px 0;font-size:22px}
    p.hint{margin:6px 0 18px;color:var(--muted);font-size:14px}
    .row{display:flex;gap:12px;align-items:stretch}
    .col{flex:1;min-width:0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:8px;border:1px solid #e6eaef;font-size:15px;box-sizing:border-box}
    .controls{margin-top:14px;display:flex;gap:12px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:0;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .link{color:var(--blue);text-decoration:none;margin-left:6px}
    .status{margin-top:12px;color:#b93b3b;font-weight:600}
    .small{font-size:13px;color:var(--muted);margin-top:10px}
    /* result */
    .result{margin-top:18px;border-radius:10px;padding:14px;border:1px dashed #e6eaef;background:#fbfdff}
    .result dt{font-weight:700;color:#233}
    .result dd{margin:0 0 8px 0;color:#333}
    .badge{float:right;padding:6px 10px;border-radius:8px;background:#f1f6ff;color:#0a3ea8;font-weight:700}
    /* responsive */
    @media (max-width:640px){
      .row{flex-direction:column}
      header img{max-height:120px}
    }
    .footer{margin-top:40px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <!-- header.png must exist in repo root -->
      <img src="header.png" alt="BA Information Technology Services" />
    </header>

    <div class="card" role="main" aria-labelledby="pageTitle">
      <div style="display:flex;align-items:center">
        <h1 id="pageTitle">Follow-up Ticket Status</h1>
      </div>
      <p class="hint">Enter the <strong>Complete name</strong> you used in the form and your <strong>Ticket number</strong> (e.g. BA-0053).</p>

      <div class="row">
        <div class="col">
          <label for="clientName">Complete name (from the form)</label>
          <input id="clientName" type="text" placeholder="e.g. Juan Dela Cruz" />
        </div>
        <div class="col" style="flex:0 0 260px">
          <label for="ticketNumber">Ticket number</label>
          <input id="ticketNumber" type="text" placeholder="e.g. BA-0053" />
        </div>
      </div>

      <div class="controls">
        <button id="checkBtn" class="btn">Check Ticket</button>
        <a id="submitFormLink" class="link" href="https://forms.gle/QrGB6FrsphuRS8Bo9" target="_blank" rel="noopener">Submit a Concern</a>
        <div style="flex:1"></div>
      </div>

      <div id="message" class="status" aria-live="polite"></div>

      <div id="ticketArea"></div>

      <p class="small">
        <strong>Note:</strong> If the page shows "Server returned HTML", open your Google Sheet and choose <em>File → Publish to the web</em> (Publish entire document). Sharing the sheet as "Anyone with the link — Viewer" is not always sufficient for the public JSON endpoint used here.
      </p>
    </div>

    <div class="footer">BA Information Technology Services</div>
  </div>

<script>
(() => {
  // CONFIG - do NOT change name of this var; if you do, change here and in code below.
  const SHEET_ID = '13fetKChhGys7GOBHwGsOMU5TDJqgiFfmPUIQUeYmfoQ';
  const SHEET_NAME = 'Tickets'; // sheet tab name exact

  // Mapping: these are 0-based indexes of columns IN THE Tickets sheet
  // Based on your sheet: A=Ticket, B=Timestamp, C=Submitter Email, D=Client Name, E=Location, F=Priority, G=Concern, H=Status, I=Assigned To, J=Resolved At, K=Internal Notes, ... N=Last Updated (maybe)
  const COL = {
    ticket: 0,
    timestamp: 1,
    submitterEmail: 2,
    clientName: 3,
    location: 4,
    priority: 5,
    concern: 6,
    status: 7,
    assignedTo: 8,
    resolvedAt: 9,
    // internalNotes: 10, // intentionally omitted from client view
    // formRow / responseLink / lastUpdated may be after
  };

  // UI elements
  const clientNameEl = document.getElementById('clientName');
  const ticketNumberEl = document.getElementById('ticketNumber');
  const checkBtn = document.getElementById('checkBtn');
  const messageEl = document.getElementById('message');
  const ticketArea = document.getElementById('ticketArea');

  checkBtn.addEventListener('click', onCheck);
  ticketNumberEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onCheck(); });
  clientNameEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onCheck(); });

  function setMessage(html, danger=false){
    messageEl.innerHTML = html || '';
    messageEl.style.color = danger ? '#b93b3b' : '#2b7a2b';
  }

  function clearResult(){
    ticketArea.innerHTML = '';
  }

  function showResultHtml(html){
    ticketArea.innerHTML = html;
  }

  function normalize(s){
    if(!s && s!==0) return '';
    return String(s).trim().toLowerCase();
  }

  async function onCheck(){
    clearResult();
    setMessage('');
    const name = clientNameEl.value || '';
    const ticket = ticketNumberEl.value || '';
    if(!name || !ticket){
      setMessage('Enter both name and ticket number.', true);
      return;
    }

    setMessage('Fetching ticket — please wait...');
    checkBtn.disabled = true;

    try {
      const rows = await fetchSheetRows();
      setMessage(''); // clear

      // find match by ticket first (ticket numbers unique)
      const ticketNorm = normalize(ticket);
      let found = null;
      for(const r of rows){
        const cellTicket = normalize(r[COL.ticket]);
        if(cellTicket === ticketNorm){
          // ticket matched; now check name
          const sheetName = normalize(r[COL.clientName] || r[COL.clientName === undefined ? 3 : COL.clientName]);
          if(sheetName === normalize(name)){
            found = r;
            break;
          } else {
            // ticket matched but name mismatch -> show helpful error
            setMessage('Ticket number found but the name you entered does not match the name on the ticket. Use the exact name from the form (no case sensitivity).', true);
            return;
          }
        }
      }

      if(!found){
        setMessage('No matching ticket found. Make sure the Ticket and Complete name match exactly the values submitted in the form.', true);
        return;
      }

      // Build result display
      const resultHtml = buildResultHtml(found);
      showResultHtml(resultHtml);

    } catch (err) {
      console.error('Fetch error', err);
      const msg = err && err.message ? err.message : String(err);
      // If server returned HTML (login page / drive page) we give clear instruction
      if(msg.indexOf('server-returned-html') !== -1){
        setMessage('The Tickets sheet could not be fetched. Make sure you published the sheet to the web (File → Publish to the web) and the sheet tab name is exactly "Tickets".', true);
      } else {
        setMessage('Error fetching tickets: ' + msg, true);
      }
    } finally {
      checkBtn.disabled = false;
    }
  }

  function buildResultHtml(row){
    // helper to pick column values safely
    const val = (idx)=> (idx>=0 && idx < row.length ? (row[idx] == null ? '' : row[idx]) : '');
    const fields = {
      ticket: val(COL.ticket),
      timestamp: val(COL.timestamp),
      submitterEmail: val(COL.submitterEmail),
      clientName: val(COL.clientName),
      location: val(COL.location),
      priority: val(COL.priority),
      concern: val(COL.concern),
      status: val(COL.status),
      assignedTo: val(COL.assignedTo),
      resolvedAt: val(COL.resolvedAt)
    };

    // create result markup
    return `
      <div class="result">
        <div style="overflow:auto">
          <div style="float:left">
            <dl>
              <dt>Ticket</dt><dd>${escapeHtml(fields.ticket || '')}</dd>
              <dt>Client</dt><dd>${escapeHtml(fields.clientName || '')}</dd>
            </dl>
          </div>
          <div style="float:right;text-align:right">
            <div class="badge">${escapeHtml(fields.status||'')}</div>
            <div style="clear:both"></div>
          </div>
        </div>
        <div style="clear:both"></div>
        <hr style="margin:10px 0;border:none;border-top:1px solid #eef2f5" />
        <dl style="display:grid;grid-template-columns:1fr 1fr;gap:8px 18px">
          <div><dt>Submitted</dt><dd>${escapeHtml(fields.timestamp||'')}</dd></div>
          <div><dt>Assigned to</dt><dd>${escapeHtml(fields.assignedTo||'')}</dd></div>
          <div><dt>Email</dt><dd>${escapeHtml(fields.submitterEmail||'')}</dd></div>
          <div><dt>Resolved at</dt><dd>${escapeHtml(fields.resolvedAt||'')}</dd></div>
          <div style="grid-column:1 / -1"><dt>Location</dt><dd>${escapeHtml(fields.location||'')}</dd></div>
          <div style="grid-column:1 / -1"><dt>Priority</dt><dd>${escapeHtml(fields.priority||'')}</dd></div>
          <div style="grid-column:1 / -1"><dt>Concern</dt><dd>${escapeHtml(fields.concern||'')}</dd></div>
        </dl>
      </div>
    `;
  }

  // Simple HTML escape
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[c]);
  }

  // Fetch sheet rows using gviz JSON endpoint and return a simple array-of-arrays
  async function fetchSheetRows(){
    // Use Google visualization API json endpoint for public sheets
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;
    const res = await fetch(url, { credentials: 'omit', cache: 'no-store' });
    if(!res.ok){
      throw new Error('Network response was not ok (' + res.status + ')');
    }
    const text = await res.text();

    // If server returned HTML (login page / drive UI), quick detect:
    const ttrim = text.trim();
    if(ttrim.startsWith('<')){
      // HTML returned instead of JSON -> probably not published to web
      const err = new Error('server-returned-html');
      err.detail = 'Server returned HTML (not JSON). Confirm sheet is published to web.';
      throw err;
    }

    // Google wraps JSON in various prefixes. The common wrappers:
    // 1) /*O_o*/\ngoogle.visualization.Query.setResponse({...});
    // 2) /**/ google.visualization.Query.setResponse(...)
    // We'll extract the {...} object:
    const start = text.indexOf('{');
    const end = text.lastIndexOf('}');
    if(start === -1 || end === -1){
      throw new Error('Unexpected server response (no JSON found).');
    }
    const jsonText = text.slice(start, end+1);
    let obj;
    try {
      obj = JSON.parse(jsonText);
    } catch (e) {
      console.error('JSON parse failed', e, jsonText.slice(0,200));
      throw new Error('Unexpected server response (invalid JSON).');
    }

    // Now parse the visualization response table -> convert to array of simple values
    if(!obj.table || !obj.table.rows) return [];
    const rows = obj.table.rows.map(r => (r.c || []).map(cell => (cell && typeof cell.v !== 'undefined') ? cell.v : ''));
    return rows;
  }

})();
</script>
</body>
</html>
