<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Follow-up Ticket Status — BA IT</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --blue:#0a6bff;
      --muted:#6c7680;
      --bg:#f5f7fb;
      --card:#ffffff;
    }
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:920px;margin:28px auto;padding:18px}
    header{display:block;text-align:center;margin-bottom:14px}
    header img{width:100%;max-height:140px;object-fit:cover;border-radius:6px;box-shadow:0 6px 18px rgba(10,10,20,.06)}
    .card{background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(10,20,40,.06)}
    h1{margin:0 0 8px 0;font-size:22px}
    p.hint{margin:6px 0 18px;color:var(--muted);font-size:14px}
    .row{display:flex;gap:12px;align-items:stretch}
    .col{flex:1;min-width:0}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"]{width:100%;padding:12px 14px;border-radius:8px;border:1px solid #e6eaef;font-size:15px;box-sizing:border-box}
    .controls{margin-top:14px;display:flex;gap:12px;align-items:center}
    .btn{background:var(--blue);color:#fff;border:0;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .link{color:var(--blue);text-decoration:none;margin-left:6px}
    .status{margin-top:12px;color:#b93b3b;font-weight:600}
    .small{font-size:13px;color:var(--muted);margin-top:10px}
    .result{margin-top:18px;border-radius:10px;padding:14px;border:1px dashed #e6eaef;background:#fbfdff}
    .result dt{font-weight:700;color:#233}
    .result dd{margin:0 0 8px 0;color:#333}
    .badge{float:right;padding:6px 10px;border-radius:8px;background:#f1f6ff;color:#0a3ea8;font-weight:700}
    @media (max-width:640px){
      .row{flex-direction:column}
      header img{max-height:120px}
    }
    .footer{margin-top:40px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="header.png" alt="BA Information Technology Services" />
    </header>

    <div class="card" role="main" aria-labelledby="pageTitle">
      <div style="display:flex;align-items:center">
        <h1 id="pageTitle">Follow-up Ticket Status</h1>
      </div>
      <p class="hint">Enter the <strong>Complete name</strong> you used in the form and your <strong>Ticket number</strong> (e.g. BA-0053).</p>

      <div class="row">
        <div class="col">
          <label for="clientName">Complete name (from the form)</label>
          <input id="clientName" type="text" placeholder="e.g. Juan Dela Cruz" />
        </div>
        <div class="col" style="flex:0 0 260px">
          <label for="ticketNumber">Ticket number</label>
          <input id="ticketNumber" type="text" placeholder="e.g. BA-0053" />
        </div>
      </div>

      <div class="controls">
        <button id="checkBtn" class="btn">Check Ticket</button>
        <a id="submitFormLink" class="link" href="https://forms.gle/QrGB6FrsphuRS8Bo9" target="_blank" rel="noopener">Submit a Concern</a>
        <div style="flex:1"></div>
      </div>

      <div id="message" class="status" aria-live="polite"></div>
      <div id="ticketArea"></div>

      <p class="small">
        Note: this page reads the published CSV of the Tickets sheet. If you see a message about HTML or "could not be fetched",
        make sure you used <strong>File → Publish to the web</strong> (and then refresh this page).
      </p>
    </div>

    <div class="footer">BA Information Technology Services</div>
  </div>

<script>
(() => {
  // ----- CONFIG: this is the published CSV link you provided -----
  const PUBLISHED_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRfRBiFS4R36jzmtv0eMcVEkpqxpgNoI_dJ0DQRUO-lJ_Un_dYNqmYbl0agA4l7V9565ECHuvKKzMM1/pub?gid=60269729&single=true&output=csv';
  // ----------------------------------------------------------------

  const clientNameEl = document.getElementById('clientName');
  const ticketNumberEl = document.getElementById('ticketNumber');
  const checkBtn = document.getElementById('checkBtn');
  const messageEl = document.getElementById('message');
  const ticketArea = document.getElementById('ticketArea');

  checkBtn.addEventListener('click', onCheck);
  ticketNumberEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onCheck(); });
  clientNameEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') onCheck(); });

  function setMessage(html, danger=false){
    messageEl.innerHTML = html || '';
    messageEl.style.color = danger ? '#b93b3b' : '#2b7a2b';
  }
  function clearResult(){ ticketArea.innerHTML = ''; }
  function showResultHtml(html){ ticketArea.innerHTML = html; }

  function normalize(s){ if(!s && s!==0) return ''; return String(s).trim().toLowerCase(); }

  async function onCheck(){
    clearResult(); setMessage('');
    const name = clientNameEl.value || '';
    const ticket = ticketNumberEl.value || '';
    if(!name || !ticket){ setMessage('Enter both name and ticket number.', true); return; }

    setMessage('Fetching tickets...');
    checkBtn.disabled = true;
    try {
      const csv = await fetchCsv(PUBLISHED_CSV);
      const { headerMap, rows } = parseCsvToRows(csv);

      if(rows.length === 0){ throw new Error('empty-csv'); }

      // find header column indexes by common names
      // tolerant matching:
      const col = {
        ticket: findHeader(headerMap, ['ticket','ticket number','ticket_no','ticket_no.','ticket_id']),
        clientName: findHeader(headerMap, ['client name','clientname','name','complete name','full name']),
        timestamp: findHeader(headerMap, ['timestamp','submitted','date','submitted at']),
        submitterEmail: findHeader(headerMap, ['submitter email','email','email address']),
        location: findHeader(headerMap, ['location','service location','address']),
        priority: findHeader(headerMap, ['priority']),
        concern: findHeader(headerMap, ['concern','issue','description']),
        status: findHeader(headerMap, ['status']),
        assigned: findHeader(headerMap, ['assigned to','assigned','assigned_to']),
        resolvedAt: findHeader(headerMap, ['resolved at','resolved_at','resolved'])
      };

      // We require at least ticket and clientName columns
      if(col.ticket === -1 || col.clientName === -1){
        throw new Error('missing-columns');
      }

      const ticketNorm = normalize(ticket);
      let foundRow = null;
      for(const r of rows){
        const tval = normalize(r[col.ticket] || '');
        if(tval === ticketNorm){
          const nval = normalize(r[col.clientName] || '');
          if(nval === normalize(name)){
            foundRow = r; break;
          } else {
            setMessage('Ticket number found but the name does not match the name on the ticket. Use the exact name from the form (case-insensitive).', true);
            return;
          }
        }
      }

      if(!foundRow){
        setMessage('No matching ticket found. Make sure both Ticket and Complete name match exactly the ticket entry.', true);
        return;
      }

      // Build display using foundRow and col indices
      const get = idx => (idx >= 0 ? (foundRow[idx] || '') : '');
      const resultHtml = `
        <div class="result">
          <div style="overflow:auto">
            <div style="float:left">
              <dl>
                <dt>Ticket</dt><dd>${escapeHtml(get(col.ticket))}</dd>
                <dt>Client</dt><dd>${escapeHtml(get(col.clientName))}</dd>
              </dl>
            </div>
            <div style="float:right;text-align:right">
              <div class="badge">${escapeHtml(get(col.status) || '')}</div>
              <div style="clear:both"></div>
            </div>
          </div>
          <div style="clear:both"></div>
          <hr style="margin:10px 0;border:none;border-top:1px solid #eef2f5" />
          <dl style="display:grid;grid-template-columns:1fr 1fr;gap:8px 18px">
            <div><dt>Submitted</dt><dd>${escapeHtml(get(col.timestamp) || '')}</dd></div>
            <div><dt>Assigned to</dt><dd>${escapeHtml(get(col.assigned) || '')}</dd></div>
            <div><dt>Email</dt><dd>${escapeHtml(get(col.submitterEmail) || '')}</dd></div>
            <div><dt>Resolved at</dt><dd>${escapeHtml(get(col.resolvedAt) || '')}</dd></div>
            <div style="grid-column:1 / -1"><dt>Location</dt><dd>${escapeHtml(get(col.location) || '')}</dd></div>
            <div style="grid-column:1 / -1"><dt>Priority</dt><dd>${escapeHtml(get(col.priority) || '')}</dd></div>
            <div style="grid-column:1 / -1"><dt>Concern</dt><dd>${escapeHtml(get(col.concern) || '')}</dd></div>
          </dl>
        </div>
      `;
      showResultHtml(resultHtml);
      setMessage('Ticket loaded.', false);

    } catch (err) {
      console.error('Error', err);
      const code = err && err.message ? err.message : '';
      if(code === 'empty-csv'){
        setMessage('The published sheet returned an empty CSV. Confirm you published the correct sheet tab.', true);
      } else if(code === 'missing-columns'){
        setMessage('The Tickets CSV is missing Ticket or Client Name columns. Make sure the Tickets sheet has headers.', true);
      } else if(code === 'server-returned-html'){
        setMessage('The published link returned HTML instead of CSV. Re-publish the sheet to the web and try again.', true);
      } else {
        setMessage('Error fetching tickets: ' + (err && err.message ? err.message : String(err)), true);
      }
    } finally {
      checkBtn.disabled = false;
    }
  }

  // fetch CSV text and do a quick validation: if HTML seems returned, throw special error
  async function fetchCsv(url){
    const res = await fetch(url, { cache: 'no-store', credentials: 'omit' });
    if(!res.ok) throw new Error('Network error: ' + res.status);
    const text = await res.text();
    const trimmed = text.trim();
    if(trimmed.startsWith('<') || trimmed.toLowerCase().includes('<!doctype html') || trimmed.toLowerCase().includes('<html')){
      // HTML returned -> publish issue
      const e = new Error('server-returned-html');
      throw e;
    }
    return text;
  }

  // parse CSV into headerMap and rows (arrays)
  function parseCsvToRows(csvText){
    // Simple CSV parse that handles quoted fields.
    const rows = [];
    let cur = '', inQuotes = false, row = [], i=0;
    while(i < csvText.length){
      const ch = csvText[i];
      if(inQuotes){
        if(ch === '"'){
          if(csvText[i+1] === '"'){ cur += '"'; i+=2; continue; }
          inQuotes = false; i++; continue;
        } else {
          cur += ch; i++; continue;
        }
      } else {
        if(ch === '"'){ inQuotes = true; i++; continue; }
        if(ch === ','){ row.push(cur); cur = ''; i++; continue; }
        if(ch === '\r'){ i++; continue; }
        if(ch === '\n'){ row.push(cur); rows.push(row); row = []; cur = ''; i++; continue; }
        cur += ch; i++;
      }
    }
    // leftover
    if(cur !== '' || row.length){
      row.push(cur);
      rows.push(row);
    }

    if(rows.length === 0) return { headerMap: {}, rows: [] };

    const headers = rows[0].map(h => String(h||'').trim());
    const headerMap = {};
    for(let j=0;j<headers.length;j++){
      headerMap[normalize(headers[j])] = j;
    }
    const dataRows = rows.slice(1);
    return { headerMap, rows: dataRows };
  }

  function findHeader(headerMap, candidates){
    for(const c of candidates){
      const k = normalize(c);
      if(k in headerMap) return headerMap[k];
    }
    // also try simple substring match (less strict)
    for(const key in headerMap){
      for(const c of candidates){
        if(key.indexOf(normalize(c)) !== -1) return headerMap[key];
      }
    }
    return -1;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[c]);
  }

})();
</script>
</body>
</html>
