<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Follow-up Ticket Status — BA IT</title>
<meta name="description" content="Check your BA support ticket by ticket number and name." />
<style>
  :root{--blue:#0a6bff;--muted:#6c7680;--bg:#f5f7fb;--card:#ffffff}
  body{margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#111}
  .wrap{max-width:820px;margin:18px auto;padding:18px}
  .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(10,20,40,.06)}
  h1{margin:0 0 8px;font-size:20px}
  .grid{display:grid;grid-template-columns:1fr 220px;gap:12px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eaf0;font-size:15px}
  .btn{background:var(--blue);color:#fff;border:0;padding:10px 14px;border-radius:9px;font-weight:700;cursor:pointer}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}
  .result{margin-top:16px;padding:14px;border-radius:10px;background:#fff;border:1px solid #eef4ff}
  .row{display:flex;gap:10px;align-items:center}
  .badge{display:inline-block;padding:6px 10px;border-radius:14px;font-weight:700;font-size:13px}
  .status-reviewing{background:#fff3cd;color:#856404;border:1px solid #ffeeba}
  .status-pending{background:#e7f3ff;color:#084298;border:1px solid #cfe3ff}
  .status-clarify{background:#ffe8e6;color:#74211b;border:1px solid #ffd6d3}
  .status-failed{background:#f8d7da;color:#842029;border:1px solid #f5c2c7}
  .status-succeeded{background:#d1e7dd;color:#0f5132;border:1px solid #badbcc}
  pre{white-space:pre-wrap;background:#fafafa;padding:10px;border-radius:8px;border:1px solid #f0f0f0}
  .link{color:var(--blue);text-decoration:underline}
  @media(max-width:720px){
    .grid{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="title">
      <h1 id="title">Follow-up Ticket Status</h1>
      <div class="muted">Enter the <strong>Complete name</strong> you used in the form and your <strong>Ticket number</strong> (e.g. BA-0053).</div>

      <div style="margin-top:12px" class="grid">
        <div>
          <label for="name">Complete name (from the form)</label>
          <input id="name" type="text" autocomplete="name" placeholder="e.g. juan dela cruz">
        </div>
        <div>
          <label for="ticket">Ticket number</label>
          <input id="ticket" type="text" placeholder="e.g. BA-0053" style="width:100%">
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="check" class="btn">Check Ticket</button>
        <a id="submitLink" class="link" href="https://forms.gle/QrGB6FrsphuRS8Bo9" target="_blank" rel="noopener">Submit a Concern</a>
        <div id="info" style="margin-left:auto" class="muted"></div>
      </div>

      <div id="message" class="muted" style="margin-top:12px"></div>

      <div id="result" class="result" style="display:none"></div>
    </div>
  </div>

<script>
/*
  CONFIG (already set with your values)
*/
const SPREADSHEET_ID = '13fetKChhGys7GOBHwGsOMU5TDJqgiFfmPUIQUeYmfoQ';
const SUBMIT_FORM_URL = 'https://forms.gle/QrGB6FrsphuRS8Bo9';
const SHEET_JSON_URL = 'https://docs.google.com/spreadsheets/d/' + SPREADSHEET_ID + '/gviz/tq?tqx=out:json&sheet=Tickets';

document.getElementById('submitLink').href = SUBMIT_FORM_URL;

const checkBtn = document.getElementById('check');
const nameInput = document.getElementById('name');
const ticketInput = document.getElementById('ticket');
const message = document.getElementById('message');
const resultBox = document.getElementById('result');
const infoEl = document.getElementById('info');

const MAX_ATTEMPTS = 5;
const LOCKOUT_MS = 3 * 60 * 60 * 1000; // 3 hours

function showMessage(text, danger=false){
  message.textContent = text;
  message.style.color = danger ? '#b21f2d' : '#333';
}

function setInfo(text){
  infoEl.textContent = text;
}

function getStorage(ticketKey){
  try{
    const raw = localStorage.getItem(ticketKey);
    return raw ? JSON.parse(raw) : {attempts:0};
  }catch(e){ return {attempts:0}; }
}
function saveStorage(ticketKey,obj){
  try{ localStorage.setItem(ticketKey, JSON.stringify(obj)); }catch(e){}
}

function lockCheck(ticketKey){
  const st = getStorage(ticketKey);
  if (st.lockedUntil && Date.now() < st.lockedUntil) {
    return {locked:true, until: st.lockedUntil};
  }
  return {locked:false};
}

function recordFailure(ticketKey){
  const st = getStorage(ticketKey);
  st.attempts = (st.attempts||0) + 1;
  if (st.attempts >= MAX_ATTEMPTS){
    st.lockedUntil = Date.now() + LOCKOUT_MS;
  }
  saveStorage(ticketKey, st);
  return st;
}

function resetAttempts(ticketKey){
  localStorage.removeItem(ticketKey);
}

/* fetch sheet via gviz JSON wrapper */
async function fetchTicketsJson(){
  const url = SHEET_JSON_URL + '&t=' + (Date.now());
  const resp = await fetch(url, {cache:'no-store'});
  if (!resp.ok) throw new Error('Unable to fetch tickets sheet (status '+resp.status+')');
  const text = await resp.text();
  // response is like: /*O_o*/\ngoogle.visualization.Query.setResponse({...});
  const jsonStr = text.replace(/^.*setResponse\(/,'').replace(/\);\s*$/,'');
  const obj = JSON.parse(jsonStr);
  return obj.table;
}

/* parse table into array of objects using header row */
function tableToObjects(table){
  const cols = table.cols.map(c => (c.label||'').toLowerCase().trim());
  const rows = table.rows.map(r => r.c.map(cell => (cell && cell.v !== undefined) ? cell.v : ''));
  const out = rows.map(row=>{
    const obj = {};
    for(let i=0;i<cols.length;i++){
      obj[cols[i]||('col'+i)] = row[i];
    }
    return obj;
  });
  return out;
}

function createStatusClass(statusText){
  if(!statusText) return 'status-pending';
  const s = statusText.toString().toLowerCase();
  if (s.includes('review')) return 'status-reviewing';
  if (s.includes('clarif') || s.includes('clarify')) return 'status-clarify';
  if (s.includes('fail')) return 'status-failed';
  if (s.includes('success') || s.includes('done') || s.includes('complete')) return 'status-succeeded';
  return 'status-pending';
}

function escapeHtml(s){
  if (s==null) return '';
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#39;');
}

checkBtn.addEventListener('click', async ()=>{
  resultBox.style.display = 'none';
  resultBox.innerHTML = '';
  setInfo('');
  showMessage('');
  const nameRaw = (nameInput.value||'').trim();
  const ticketRaw = (ticketInput.value||'').trim();
  if (!nameRaw || !ticketRaw){
    showMessage('Please enter both the name and ticket number.', true);
    return;
  }
  const ticketKey = 'ticket_' + ticketRaw.toLowerCase();
  // check client lock
  const lock = lockCheck(ticketKey);
  if (lock.locked){
    const until = new Date(lock.until);
    showMessage('Too many attempts. This ticket is locked until: ' + until.toLocaleString(), true);
    return;
  }

  showMessage('Checking...');

  try{
    const table = await fetchTicketsJson();
    const rows = tableToObjects(table);

    // normalize headers
    const headerNames = table.cols.map(c=> (c.label||'').toLowerCase().trim());
    // determine probable keys (falling back to common positions)
    function findKey(names){
      for(const n of names){
        const i = headerNames.indexOf(n);
        if (i !== -1) return headerNames[i];
      }
      return null;
    }
    const keyTicket = findKey(['ticket','ticket id','id']) || headerNames[0];
    const keyName   = findKey(['name','full name','client name']) || headerNames[1] || headerNames[2];
    const keyEmail  = findKey(['email','email address','submitter email']) || headerNames.find(h=>h.includes('email')) || headerNames[2] || '';
    const keyLocation= findKey(['location','service location','address']) || headerNames.find(h=>h.includes('location')) || '';
    const keyConcern = findKey(['concern','issue','message','description','type of request']) 
                         || headerNames.find(h=>h.includes('concern')) || headerNames.find(h=>h.includes('description')) || '';
    const keyStatus  = findKey(['status']) || headerNames.find(h=>h.includes('status')) || '';

    // search row by ticket (case-insensitive)
    const found = rows.find(r => {
      const t = (r[keyTicket]||'').toString().trim();
      return t.toLowerCase() === ticketRaw.toLowerCase();
    });

    if (!found){
      // increment attempts
      const st = recordFailure(ticketKey);
      const left = Math.max(0, MAX_ATTEMPTS - (st.attempts||0));
      if (st.lockedUntil) {
        showMessage('Ticket not found. Too many failed attempts — ticket locked for 3 hours.', true);
      } else {
        showMessage('Ticket number not found. Please check your confirmation email for the ticket number. Attempts left: '+left, true);
      }
      return;
    }

    // check name match (case-insensitive, trimmed)
    const sheetName = (found[keyName]||'').toString().trim().toLowerCase();
    if (sheetName !== nameRaw.toLowerCase()){
      const st = recordFailure(ticketKey);
      const left = Math.max(0, MAX_ATTEMPTS - (st.attempts||0));
      if (st.lockedUntil){
        showMessage('Name mismatch. Too many failed attempts — locked 3 hours.', true);
      } else {
        showMessage('Name does not match the name used when submitting the form. Please use the exact name from the email. Attempts left: '+left, true);
      }
      return;
    }

    // success — reset attempts
    resetAttempts(ticketKey);

    // render details
    const statusText = found[keyStatus] || '';
    const statusClass = createStatusClass(statusText);
    let html = '';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">';
    html += '<div><strong>' + escapeHtml(found[keyTicket]||ticketRaw) + '</strong><div class="muted" style="font-size:13px;margin-top:6px">Submitted: ' + escapeHtml(found.timestamp || '') + '</div></div>';
    html += '<div><span class="badge ' + statusClass + '">' + escapeHtml(statusText || 'Pending') + '</span></div>';
    html += '</div>';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
    html += '<div><strong>Name</strong><div style="margin-top:6px">' + escapeHtml(found[keyName]||'') + '</div></div>';
    html += '<div><strong>Email</strong><div style="margin-top:6px">' + escapeHtml(found[keyEmail]||'') + '</div></div>';
    html += '</div>';
    html += '<div style="margin-top:12px"><strong>Location</strong><div style="margin-top:6px">' + escapeHtml(found[keyLocation]||'') + '</div></div>';
    html += '<div style="margin-top:12px"><strong>Concern / Message</strong><pre>' + escapeHtml(found[keyConcern]||'') + '</pre></div>';
    html += '<div style="margin-top:10px"><a class="link" href="'+SUBMIT_FORM_URL+'" target="_blank">Submit another concern</a></div>';

    resultBox.innerHTML = html;
    resultBox.style.display = 'block';
    showMessage('Ticket found.');
    setInfo('');
  }catch(err){
    console.error(err);
    showMessage('Error fetching tickets: ' + err.message, true);
  }
});
</script>
</body>
</html>
